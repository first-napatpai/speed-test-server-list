<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test Server URL Data Search</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">

    <style>
        /* Keep scrollbar always visible to avoid layout shift */
        html {
            overflow-y: scroll;
        }

        body {
            font-family: 'Source Code Pro', monospace;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* Mobile "data-label: Country / Host / ..." before values */
        @media (max-width: 767px) {
            tbody td[data-label]::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 6.5rem;
                padding-left: 1.5rem;
                padding-right: 0.5rem;
                text-align: left;
                font-weight: 600;
                color: #4b5563; /* text-gray-600 */
                font-size: 0.75rem; /* text-xs */
                line-height: 1rem;  /* leading-tight */
            }
        }

        /* Desktop row hover */
        @media (min-width: 768px) {
            tbody tr:hover {
                background-color: #f9fafb; /* bg-gray-50 */
            }
        }

        /* Disabled pagination buttons */
        li.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        li.disabled button {
            cursor: not-allowed;
        }

        /* Search placeholder */
        #search-bar::placeholder {
            color: #9ca3af; /* text-gray-400 */
        }

        /* Hide horizontal scrollbar bar chrome */
        .table-scroll-container::-webkit-scrollbar {
            display: none;
        }
        .table-scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- FULL-WIDTH TERMINAL BAR -->
    <!-- This spans 100% width across the viewport -->
    <div class="w-full bg-gray-100 border border-gray-200 rounded-t-lg md:rounded-lg md:rounded-b-none shadow-md md:shadow-none md:border-b-0">

        <!-- Inner row is centered but allowed to be very wide -->
        <div class="max-w-[90rem] mx-auto flex items-center h-10 px-3 sm:px-4 text-xs sm:text-sm">

            <!-- traffic light dots -->
            <div class="flex space-x-1.5 sm:space-x-2 shrink-0">
                <div class="h-3 w-3 sm:h-3.5 sm:w-3.5 bg-red-400 rounded-full border border-red-500"></div>
                <div class="h-3 w-3 sm:h-3.5 sm:w-3.5 bg-yellow-400 rounded-full border border-yellow-500"></div>
                <div class="h-3 w-3 sm:h-3.5 sm:w-3.5 bg-green-400 rounded-full border border-green-500"></div>
            </div>

            <!-- path text -->
            <div class="flex-1 text-center text-gray-600 truncate px-2">
                <span class="sm:hidden">user@speedtest</span>
                <span class="hidden sm:inline">user@speedtest: ~/data</span>
            </div>

            <div class="w-8 sm:w-16"></div>
        </div>
    </div>

    <!-- CONTENT CARD -->
    <!-- This is still readable width -->
    <div class="max-w-6xl mx-auto bg-white rounded-b-lg md:rounded-lg shadow-md border border-gray-200 border-t-0 md:border-t border-gray-200 overflow-hidden font-mono md:min-h-screen flex flex-col">

        <div class="p-4 sm:p-6 md:p-8 flex flex-col flex-1">

            <!-- Title -->
            <h1 class="text-xl sm:text-2xl md:text-3xl font-semibold text-gray-800 mb-4 sm:mb-6">
                Speed Test Server Search
            </h1>

            <!-- Search box -->
            <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-gray-50 border border-gray-200 rounded-lg">
                <div class="flex flex-col xs:flex-row xs:items-center gap-2">
                    <label for="search-bar" class="text-gray-500 font-bold text-sm sm:text-md leading-none whitespace-nowrap">
                        [search]$
                    </label>
                    <input
                        type="text"
                        id="search-bar"
                        placeholder="e.g., 'United States', 'Sparklight', 'siouxcity'..."
                        class="w-full bg-transparent border-none text-gray-900 p-0 focus:ring-0 text-sm sm:text-base placeholder-gray-400"
                    >
                </div>
            </div>

            <!-- Timestamp -->
            <div class="mb-4 sm:mb-6 -mt-1 text-[10px] leading-tight sm:text-xs text-gray-500 text-right">
                Last updated:
                <span id="data-last-updated-timestamp"><!-- LAST_UPDATED_JENKINS --></span>
            </div>

            <!-- Controls row -->
            <div class="mb-4 flex flex-col sm:flex-row gap-3 sm:gap-4 sm:items-center sm:justify-between">

                <!-- Left: Show N entries -->
                <div class="flex flex-wrap items-center gap-2 text-xs sm:text-sm text-gray-700">
                    <label for="records-per-page" class="whitespace-nowrap">Show</label>
                    <select
                        id="records-per-page"
                        class="w-20 px-2 py-1 bg-white border border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 text-xs sm:text-sm"
                    >
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="250">250</option>
                    </select>
                    <span class="whitespace-nowrap">entries</span>
                </div>

                <!-- Right: Results info -->
                <div
                    id="results-info"
                    class="text-xs sm:text-sm text-gray-700 text-left sm:text-right"
                >
                    Loading results...
                </div>
            </div>

            <!-- Table wrapper -->
            <div class="overflow-x-auto table-scroll-container -mx-4 sm:mx-0 px-4 sm:px-0">
                <table class="w-full">
                    <thead class="hidden md:table-header-group bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Country
                            </th>
                            <th scope="col" class="px-4 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Sponsor
                            </th>
                            <th scope="col" class="px-4 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Location (Name)
                            </th>
                            <th scope="col" class="px-4 sm:px-6 py-3 text-left text-[10px] sm:text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                Host
                            </th>
                        </tr>
                    </thead>

                    <tbody id="results-body" class="block md:table-row-group divide-y divide-gray-200">
                        <tr>
                            <td class="block md:table-cell px-4 sm:px-6 py-4 text-center text-sm text-gray-500" colspan="4">
                                Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="mt-6 flex items-center justify-center md:justify-end">
                <nav aria-label="Pagination" class="w-full md:w-auto">
                    <ul
                        id="pagination-list"
                        class="flex flex-wrap items-center justify-center md:justify-end gap-1 sm:gap-0 md:-space-x-px text-xs sm:text-sm"
                    >
                        <!-- Pagination buttons go here -->
                    </ul>
                </nav>
            </div>

        </div> <!-- /inner content -->
    </div> <!-- /card -->

    <script>
        // --- Element References ---
        const searchInput = document.getElementById('search-bar');
        const tableBody = document.getElementById('results-body');
        const resultsInfo = document.getElementById('results-info');
        const paginationList = document.getElementById('pagination-list');
        const recordsPerPageSelect = document.getElementById('records-per-page');
        const lastUpdatedElement = document.getElementById('data-last-updated-timestamp');
        
        // --- State ---
        let allServerData = [];
        let filteredServerData = [];
        let currentPage = 1;
        let recordsPerPage = 100;

        function debounce(func, delay = 250) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function renderTable(data) {
            tableBody.innerHTML = '';

            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td class="block md:table-cell px-4 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center" colspan="4">
                            No results found.
                        </td>
                    </tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                row.className = [
                    'block md:table-row mb-4 md:mb-0',
                    'border border-gray-200 md:border-b md:border-gray-200',
                    'rounded-lg md:rounded-none',
                    'shadow-sm md:shadow-none',
                    'overflow-hidden md:overflow-visible',
                    'bg-white'
                ].join(' ');

                row.innerHTML = `
                    <td
                        class="block md:table-cell text-right md:text-left px-4 sm:px-6 py-3 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-[13px] leading-snug sm:text-sm text-gray-900"
                        data-label="Country"
                    >
                        ${item.country || ''}
                    </td>

                    <td
                        class="block md:table-cell text-right md:text-left px-4 sm:px-6 py-3 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-[13px] leading-snug sm:text-sm text-gray-900"
                        data-label="Sponsor"
                    >
                        ${item.sponsor || ''}
                    </td>

                    <td
                        class="block md:table-cell text-right md:text-left px-4 sm:px-6 py-3 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-[12px] leading-snug sm:text-sm text-gray-600"
                        data-label="Location"
                    >
                        ${item.name || ''}
                    </td>

                    <td
                        class="block md:table-cell text-right md:text-left px-4 sm:px-6 py-3 whitespace-normal break-all relative md:static pl-28 md:pl-6 text-[12px] leading-snug sm:text-sm text-gray-600"
                        data-label="Host"
                    >
                        ${item.host || ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getPaginationNumbers(totalPages, currentPage) {
            const pagesToShow = 5;
            const sideWidth = Math.floor(pagesToShow / 2);
            let start, end;

            if (totalPages <= pagesToShow) {
                start = 1;
                end = totalPages;
            } else if (currentPage <= sideWidth + 1) {
                start = 1;
                end = pagesToShow;
            } else if (currentPage >= totalPages - sideWidth) {
                start = totalPages - pagesToShow + 1;
                end = totalPages;
            } else {
                start = currentPage - sideWidth;
                end = currentPage + sideWidth;
            }

            const pages = Array.from({ length: (end - start + 1) }, (_, i) => start + i);

            const result = [];
            if (start > 1) {
                result.push(1);
                if (start > 2) result.push('...');
            }

            result.push(...pages);

            if (end < totalPages) {
                if (end < totalPages - 1) result.push('...');
                result.push(totalPages);
            }
            return result;
        }

        function renderPaginationControls() {
            paginationList.innerHTML = '';

            const totalResults = filteredServerData.length;
            let totalPages = Math.ceil(totalResults / recordsPerPage);
            if (totalPages === 0) totalPages = 1;

            // Prev
            const prevLi = document.createElement('li');
            const isDisabledPrev = currentPage === 1;
            if (isDisabledPrev) prevLi.classList.add('disabled');

            prevLi.innerHTML = `
                <button
                    type="button"
                    class="flex items-center justify-center px-2.5 sm:px-3 h-9 sm:h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-lg sm:rounded-s-lg sm:rounded-e-none hover:bg-gray-100 hover:text-gray-700 ${isDisabledPrev ? 'cursor-not-allowed' : ''}"
                >
                    Prev
                </button>
            `;
            if (!isDisabledPrev) {
                prevLi.querySelector('button').addEventListener('click', () => goToPage(currentPage - 1));
            }
            paginationList.appendChild(prevLi);

            // Pages
            const pageNumbers = getPaginationNumbers(totalPages, currentPage);
            pageNumbers.forEach(page => {
                const pageLi = document.createElement('li');

                if (page === '...') {
                    pageLi.innerHTML = `
                        <span class="flex items-center justify-center px-2.5 sm:px-3 h-9 sm:h-8 leading-tight text-gray-500 bg-white border border-gray-300 text-center select-none">
                            ...
                        </span>
                    `;
                } else {
                    const isActive = page === currentPage;
                    pageLi.innerHTML = `
                        <button
                            type="button"
                            class="flex items-center justify-center px-2.5 sm:px-3 h-9 sm:h-8 leading-tight border text-center ${
                                isActive
                                    ? 'text-blue-600 bg-blue-50 border-blue-300 hover:bg-blue-100 hover:text-blue-700 font-semibold'
                                    : 'text-gray-500 bg-white border-gray-300 hover:bg-gray-100 hover:text-gray-700'
                            }"
                        >
                            ${page}
                        </button>
                    `;
                    if (!isActive) {
                        pageLi.querySelector('button').addEventListener('click', () => goToPage(page));
                    }
                }
                paginationList.appendChild(pageLi);
            });

            // Next
            const nextLi = document.createElement('li');
            const isDisabledNext = currentPage === totalPages;
            if (isDisabledNext) nextLi.classList.add('disabled');

            nextLi.innerHTML = `
                <button
                    type="button"
                    class="flex items-center justify-center px-2.5 sm:px-3 h-9 sm:h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-lg sm:rounded-e-lg sm:rounded-s-none hover:bg-gray-100 hover:text-gray-700 ${isDisabledNext ? 'cursor-not-allowed' : ''}"
                >
                    Next
                </button>
            `;
            if (!isDisabledNext) {
                nextLi.querySelector('button').addEventListener('click', () => goToPage(currentPage + 1));
            }
            paginationList.appendChild(nextLi);
        }

        function updateResultsInfo() {
            const totalResults = filteredServerData.length;
            const startIndex = (currentPage - 1) * recordsPerPage;

            const startNum = totalResults === 0 ? 0 : startIndex + 1;
            const endNum = Math.min(startIndex + recordsPerPage, totalResults);

            resultsInfo.textContent = `Showing ${startNum}-${endNum} of ${totalResults} results.`;
        }

        function goToPage(page) {
            let totalPages = Math.ceil(filteredServerData.length / recordsPerPage);
            if (totalPages === 0) totalPages = 1;

            if (page >= 1 && page <= totalPages) {
                const prevScrollY = window.scrollY;

                currentPage = page;
                renderPage();

                window.scrollTo({
                    top: prevScrollY,
                    left: 0,
                    behavior: "auto"
                });
            }
        }

        function renderPage() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;

            const dataToShow = filteredServerData.slice(startIndex, endIndex);

            renderTable(dataToShow);
            renderPaginationControls();
            updateResultsInfo();
        }

        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();

            filteredServerData = allServerData.filter(item => {
                const countryMatch = (item.country || '').toLowerCase().includes(searchTerm);
                const sponsorMatch = (item.sponsor || '').toLowerCase().includes(searchTerm);
                const hostMatch = (item.host || '').toLowerCase().includes(searchTerm);
                const nameMatch = (item.name || '').toLowerCase().includes(searchTerm);
                
                return countryMatch || sponsorMatch || hostMatch || nameMatch;
            });

            currentPage = 1;
            renderPage();
        }

        // ---- INIT ----
        document.addEventListener('DOMContentLoaded', () => {
            recordsPerPage = parseInt(recordsPerPageSelect.value, 10);

            // optimistic timestamp if Jenkins placeholder is still there
            if (
                lastUpdatedElement &&
                lastUpdatedElement.innerHTML.includes('<!-- LAST_UPDATED_JENKINS -->')
            ) {
                lastUpdatedElement.textContent = new Date().toLocaleString() + " (loading...)";
            }

            fetch('speedtest_servers.json')
                .then(response => {
                    // Instead of throwing, handle gracefully
                    const lastModified = response.headers.get('Last-Modified');
                    if (
                        lastUpdatedElement &&
                        lastUpdatedElement.innerHTML.includes('(loading...)')
                    ) {
                        if (lastModified) {
                            lastUpdatedElement.textContent = new Date(lastModified).toLocaleString();
                        } else {
                            lastUpdatedElement.textContent = new Date().toLocaleString() + " (page loaded)";
                        }
                    }

                    if (!response.ok) {
                        // return empty data fallback
                        return [];
                    }

                    return response.json();
                })
                .then(data => {
                    // If we got [], that's fine
                    allServerData = Array.isArray(data) ? data : [];
                    filteredServerData = allServerData;

                    renderPage();

                    searchInput.addEventListener('input', debounce(handleSearch, 300));
                    recordsPerPageSelect.addEventListener('change', () => {
                        recordsPerPage = parseInt(recordsPerPageSelect.value, 10);
                        currentPage = 1;
                        renderPage();
                    });
                })
                .catch(err => {
                    console.error('Error loading server data:', err);

                    // fallback state so UI still renders and doesn't look frozen
                    allServerData = [];
                    filteredServerData = [];

                    renderPage();

                    resultsInfo.textContent = 'Error loading data.';
                    tableBody.innerHTML = `
                        <tr>
                            <td class="block md:table-cell px-4 sm:px-6 py-4 text-sm text-red-600 text-center" colspan="4">
                                <strong>Error:</strong> Could not load 'speedtest_servers.json'.<br>
                                Please make sure the file exists and is valid JSON.
                            </td>
                        </tr>`;
                });
        });
    </script>
</body>
</html>
