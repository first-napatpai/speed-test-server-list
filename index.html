<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speed Test Server URL Data Search</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use the Inter font family for a cleaner look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Use Inter as the default font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* ... existing responsive table styles ... */
        @media (max-width: 767px) {
            tbody td[data-label]::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 6.5rem;
                padding-left: 1.5rem;
                padding-right: 0.5rem;
                text-align: left;
                font-weight: 600;
                color: #4b5563;
            }
        }

        @media (min-width: 768px) {
            tbody tr:hover {
                background-color: #f9fafb;
            }
        }

        /* Styles for disabled pagination buttons */
        /* We apply this to the LI parent for easier logic */
        li.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        li.disabled button {
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md">

        <!-- Header -->
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">Speed Test Server URL Data Search</h1>

        <!-- 2. The Search Bar -->
        <div class="mb-6">
            <label for="search-bar" class="block text-sm font-medium text-gray-700 mb-1">Search by Country, Sponsor, Host, or Location:</label>
            <input type="text" id="search-bar" placeholder="e.g., 'United States', 'Sparklight', 'siouxcity'..."
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
        </div>

        <!-- Last Updated Timestamp -->
        <div class="mb-6 -mt-2 text-xs text-gray-500 text-right">
            Last updated: <span id="data-last-updated-timestamp">10/27/2025, 07:07:05 PM GMT+7</span>
        </div>

        <!-- Results Info -->
        <div class="mb-4 text-sm text-gray-600" id="results-info">
            Loading results...
        </div>

        <!-- 3. The Data Table Container -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="hidden md:table-header-group bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Country</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sponsor</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location (Name)</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Host</th>
                    </tr>
                </thead>
                <tbody id="results-body" class="block md:table-row-group divide-y divide-gray-200">
                    <tr>
                        <td class="block md:table-cell px-6 py-4 text-center text-sm text-gray-500" colspan="4">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 4. Pagination Controls -->
        <div class="mt-6 flex flex-col md:flex-row items-center justify-between">
            <!-- This will be populated by JS -->
            <nav aria-label="Pagination" class="w-full">
                <ul id="pagination-list" class="flex items-center justify-center md:justify-end -space-x-px text-sm">
                    <!-- Pagination items will be generated here -->
                </ul>
            </nav>
        </div>

    </div>

    <!-- 5. JavaScript for Data and Search -->
    <script>
        // --- Element References ---
        const searchInput = document.getElementById('search-bar');
        const tableBody = document.getElementById('results-body');
        const resultsInfo = document.getElementById('results-info');
        // --- NEW: Reference to the pagination list ---
        const paginationList = document.getElementById('pagination-list');
        
        // --- State Variables ---
        let allServerData = []; // Holds all data from JSON
        let filteredServerData = []; // Holds data after search filter
        let currentPage = 1;
        const recordsPerPage = 100;

        /**
         * Debounce function (no changes)
         */
        function debounce(func, delay = 250) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        /**
         * Renders the table rows for a *specific page* of data.
         * (No changes from previous version)
         */
        function renderTable(data) {
            tableBody.innerHTML = ''; // Clear the existing table body

            if (data.length === 0) {
                tableBody.innerHTML = `<tr>
                    <td class="block md:table-cell px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center" colspan="4">
                        No results found.
                    </td>
                </tr>`;
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'block md:table-row mb-4 md:mb-0 border border-gray-200 md:border-b md:border-gray-200 rounded-lg md:rounded-none shadow-md md:shadow-none overflow-hidden md:overflow-auto';
                row.innerHTML = `
                    <td class="block md:table-cell text-right md:text-left px-6 py-4 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-sm text-gray-900" data-label="Country">
                        ${item.country || ''}
                    </td>
                    <td class="block md:table-cell text-right md:text-left px-6 py-4 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-sm text-gray-900" data-label="Sponsor">
                        ${item.sponsor || ''}
                    </td>
                    <td class="block md:table-cell text-right md:text-left px-6 py-4 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-sm text-gray-500" data-label="Location">
                        ${item.name || ''}
                    </td>
                    <td class="block md:table-cell text-right md:text-left px-6 py-4 whitespace-normal break-words relative md:static pl-28 md:pl-6 text-sm text-gray-500" data-label="Host">
                        ${item.host || ''}
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        /**
         * --- NEW: Creates the array of page numbers and ellipses ---
         * This determines what page numbers to show in the control.
         */
        function getPaginationNumbers(totalPages, currentPage) {
            const pagesToShow = 5; // How many page numbers to show (e.g., 1, 2, 3, 4, 5 or ... 8, 9, 10, 11, 12 ...)
            const sideWidth = Math.floor(pagesToShow / 2);
            let start, end;

            if (totalPages <= pagesToShow) {
                start = 1;
                end = totalPages;
            } else if (currentPage <= sideWidth + 1) {
                start = 1;
                end = pagesToShow;
            } else if (currentPage >= totalPages - sideWidth) {
                start = totalPages - pagesToShow + 1;
                end = totalPages;
            } else {
                start = currentPage - sideWidth;
                end = currentPage + sideWidth;
            }

            const pages = Array.from({ length: (end - start + 1) }, (_, i) => start + i);

            // Add ellipses and first/last page
            const result = [];
            if (start > 1) {
                result.push(1);
                if (start > 2) result.push('...');
            }
            result.push(...pages);
            if (end < totalPages) {
                if (end < totalPages - 1) result.push('...');
                result.push(totalPages);
            }
            return result;
        }

        /**
         * --- REWRITTEN: Updates the pagination controls (buttons and page info) ---
         */
        function renderPaginationControls() {
            paginationList.innerHTML = ''; // Clear existing controls
            const totalResults = filteredServerData.length;
            let totalPages = Math.ceil(totalResults / recordsPerPage);
            if (totalPages === 0) totalPages = 1;

            // 1. Create "Previous" button
            const prevLi = document.createElement('li');
            const isDisabledPrev = currentPage === 1;
            if (isDisabledPrev) prevLi.classList.add('disabled');
            prevLi.innerHTML = `
                <button class="flex items-center justify-center px-3 h-8 ms-0 leading-tight text-gray-500 bg-white border border-e-0 border-gray-300 rounded-s-lg hover:bg-gray-100 hover:text-gray-700">
                    Previous
                </button>
            `;
            if (!isDisabledPrev) {
                prevLi.querySelector('button').addEventListener('click', () => goToPage(currentPage - 1));
            }
            paginationList.appendChild(prevLi);

            // 2. Create Page Number buttons
            const pageNumbers = getPaginationNumbers(totalPages, currentPage);
            pageNumbers.forEach(page => {
                const pageLi = document.createElement('li');
                if (page === '...') {
                    pageLi.innerHTML = `<span class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300">...</span>`;
                } else {
                    const isActive = page === currentPage;
                    pageLi.innerHTML = `
                        <button class="flex items-center justify-center px-3 h-8 leading-tight ${isActive ? 'text-blue-600 bg-blue-50 border-blue-300 hover:bg-blue-100 hover:text-blue-700' : 'text-gray-500 bg-white border border-gray-300 hover:bg-gray-100 hover:text-gray-700'}">
                            ${page}
                        </button>
                    `;
                    if (!isActive) {
                        pageLi.querySelector('button').addEventListener('click', () => goToPage(page));
                    }
                }
                paginationList.appendChild(pageLi);
            });

            // 3. Create "Next" button
            const nextLi = document.createElement('li');
            const isDisabledNext = currentPage === totalPages;
            if (isDisabledNext) nextLi.classList.add('disabled');
            nextLi.innerHTML = `
                <button class="flex items-center justify-center px-3 h-8 leading-tight text-gray-500 bg-white border border-gray-300 rounded-e-lg hover:bg-gray-100 hover:text-gray-700">
                    Next
                </button>
            `;
            if (!isDisabledNext) {
                nextLi.querySelector('button').addEventListener('click', () => goToPage(currentPage + 1));
            }
            paginationList.appendChild(nextLi);
        }

        /**
         * Updates the "Showing X-Y of Z results" text
         * (No changes from previous version)
         */
        function updateResultsInfo() {
            const totalResults = filteredServerData.length;
            const startIndex = (currentPage - 1) * recordsPerPage;
            
            const startNum = totalResults === 0 ? 0 : startIndex + 1;
            const endNum = Math.min(startIndex + recordsPerPage, totalResults);

            resultsInfo.textContent = `Showing ${startNum}-${endNum} of ${totalResults} results.`;
        }

        /**
         * --- NEW: Helper function to navigate pages ---
         */
        function goToPage(page) {
            const totalPages = Math.ceil(filteredServerData.length / recordsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderPage();
            }
        }

        /**
         * Slices the filtered data and renders the table and controls.
         * (No changes from previous version)
         */
        function renderPage() {
            const startIndex = (currentPage - 1) * recordsPerPage;
            const endIndex = startIndex + recordsPerPage;
            
            const dataToShow = filteredServerData.slice(startIndex, endIndex);
            
            renderTable(dataToShow);
            renderPaginationControls();
            updateResultsInfo();
        }


        /**
         * Filters all data based on the search term and renders the first page.
         * (No changes from previous version)
         */
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();

            filteredServerData = allServerData.filter(item => {
                const countryMatch = (item.country || '').toLowerCase().includes(searchTerm);
                const sponsorMatch = (item.sponsor || '').toLowerCase().includes(searchTerm);
                const hostMatch = (item.host || '').toLowerCase().includes(searchTerm);
                const nameMatch = (item.name || '').toLowerCase().includes(searchTerm);
                
                return countryMatch || sponsorMatch || hostMatch || nameMatch;
            });

            currentPage = 1; // Reset to first page after a new search
            renderPage(); // Re-render the page
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            fetch('speedtest_servers.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const lastModified = response.headers.get('Last-Modified');
                    const lastUpdatedElement = document.getElementById('data-last-updated-timestamp');
                    
                    if (lastUpdatedElement && lastUpdatedElement.innerHTML.includes('<!-- LAST_UPDATED_JENKINS -->')) {
                        if (lastModified) {
                            lastUpdatedElement.textContent = new Date(lastModified).toLocaleString();
                        } else {
                            lastUpdatedElement.textContent = new Date().toLocaleString() + " (page loaded)";
                        }
                    }
                    
                    return response.json();
                })
                .then(data => {
                    allServerData = data;
                    filteredServerData = data; // Initially, filtered data is all data
                    
                    renderPage(); // Render the first page

                    // Attach search listener
                    searchInput.addEventListener('input', debounce(handleSearch, 300));

                    // --- REMOVED: Old pagination listeners are no longer needed
                    // as they are created dynamically in renderPaginationControls
                })
                .catch(error => {
                    console.error('Error loading server data:', error);
                    resultsInfo.textContent = 'Error loading data.';
                    tableBody.innerHTML = `<tr>
                        <td class="block md:table-cell px-6 py-4 text-sm text-red-600 text-center" colspan="4">
                            <strong>Error:</strong> Could not load 'speedtest_servers.json'.<br>
                            Please make sure the file exists and is valid JSON.
                        </td>
                    </tr>`;
                });
        });

    </script>
</body>
</html>

